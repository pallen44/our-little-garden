name: Daily Stage Check

on:
  schedule:
    - cron: "0 16 * * *"   # 10:00 AM US Central Time
  workflow_dispatch:

jobs:
  check_and_notify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Get current date stage
        id: stage
        run: |
          DAY=$(date -u +"%d")
          MONTH=$(date -u +"%m")

          STAGE=2

          if [ "$MONTH" -eq 12 ]; then
            if [ "$DAY" -ge 1 ]; then STAGE=0; fi
            if [ "$DAY" -ge 3 ]; then STAGE=1; fi
            if [ "$DAY" -ge 9 ]; then STAGE=2; fi
            if [ "$DAY" -ge 13 ]; then STAGE=3; fi
            if [ "$DAY" -ge 17 ]; then STAGE=4; fi
            if [ "$DAY" -ge 21"]; then STAGE=5; fi
            if [ "$DAY" -ge 25"]; then STAGE=6; fi
          fi

          echo "stage=$STAGE" >> $GITHUB_OUTPUT

      - name: Read last stage
        id: read_last
        run: |
          LAST=$(cat current_stage.txt)
          echo "last=$LAST" >> $GITHUB_OUTPUT

      - name: Compare stages
        id: compare
        run: |
          if [ "${{ steps.stage.outputs.stage }}" != "${{ steps.read_last.outputs.last }}" ]; then
            echo "changed=true" >> $GITHUB_OUTPUT
          else
            echo "changed=false" >> $GITHUB_OUTPUT
          fi

      - name: Send SMS via Twilio
        if: steps.compare.outputs.changed == 'true'
        run: |
          curl -X POST "https://api.twilio.com/2010-04-01/Accounts/${{ secrets.TWILIO_ACCOUNT_SID }}/Messages.json" \
          --data-urlencode "Body=Your little Christmas garden just grew ðŸŒ±" \
          --data-urlencode "From=${{ secrets.TWILIO_PHONE }}" \
          --data-urlencode "To=${{ secrets.TO_PHONE }}" \
          -u "${{ secrets.TWILIO_ACCOUNT_SID }}:${{ secrets.TWILIO_AUTH_TOKEN }}"

      - name: Update current_stage file
        if: steps.compare.outputs.changed == 'true'
        run: |
          echo "${{ steps.stage.outputs.stage }}" > current_stage.txt
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add current_stage.txt
          git commit -m "Update stage to ${{ steps.stage.outputs.stage }}"
          git push
